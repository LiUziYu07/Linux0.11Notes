#  Linux0.11源代码阅读

## 微型计算机组成原理

CPU通过三条总线(地址总线、数据总线、控制总线)与系统中其他部分进行通信

### 现代计算机的总线结构

总线结构为了提高传输速率,与8086相比产生了很大的变化,使用两个超大规模芯片构成的芯片组和芯片集构成(南桥芯片与北桥芯片),但依旧与传统的PC机硬件上兼容.

![总线结构](%E7%B4%A0%E6%9D%90/%E6%80%BB%E7%BA%BF%E7%BB%93%E6%9E%84.jpg)

#### I/O端口和访问控制方式

CPU需要地址才可以访问控制器或者控制卡上的数据和状态信息,就类似于查户口的工作人员需要知道你家的门牌号才能找到你家查户口.

##### 两种编址方法:统一编址和独立编址:

+ 统一编址:将I/O端口当作内存来寻址,CPU访问一个端口的操作与访问内存的操作一样

+ 独立编址:将I/O端口控制器和控制卡的寻址空间看作一个独立的空间来寻址.称为I/O地址空间,每个端口对应一个I/O地址,有专门的I/O指令访问端口

##### Linux采用的编址方式:

+ IBM PC机及其兼容机采用主要独立编址方式,使用ISA(工业标准体系结构)总线结构的传统PC及其I/O地址空间0x000–0x3FF有1024个端口可用

+ 但IBM  PC机也部分使用统一编址方式,例如CGA显示卡上显示内存的地址就直接占用了存储地址空间0xB800–0xBC00范围

+ Linux下可通过查看/proc/ioports文件可以得到相关控制器或设置使用的I/O地址范围:

  ![I:O端口](%E7%B4%A0%E6%9D%90/I:O%E7%AB%AF%E5%8F%A3.JPG)

+ 对于使用EISA或PCI等总线结构的现代PC机,有64KB的I/O地址空间可以使用

### 接口访问控制

#### 接口数据的传输方式:一般采用循环查询方式、中断处理方式和DMA传输方式

+ 循环查询方式,无需过多硬件支持,但耗费CPU时间较多,Linux中很少使用(仅当设备或控制器能立刻返回信息时)

+ 中断处理需要中断控制器的支持,Linux中绝大多数设备I/O控制都采用中断处理

+ DMA传输方式:需要DMA控制器,无需CPU,效率较高,Linux中软盘驱动程序使用中断和DMA方式配合来实现数据的传输

### 存储器

+ 主存

  现代CPU的物理内存寻址范围高达4GB,为了与原来的PC机在软件上兼容,系统1MB以下物理内存使用分配上仍然保持与原来PC机基本一致,而BIOS原来所在的位置,仍然用于复制BIOS代码.

###### 启动计算机

计算机家电初始化后,有4GB的物理地址空间,除了地址0xA0000到0xFFFFF和0xFFFE00到0xFFFFFFFF范围以外的内存均可用作系统内存.这两个区域被用于I/O设备和BIOS程序

假定计算机中有16MB物理内存

+ 0——640K将被用于存放内核代码和数据
+ 640K——1M之间的384K仍然保留用作图中之名的用途
  + 0xA0000开始的128K用作显示内存缓冲区,随后部分用于其他控制卡的ROM BIOS或其映射区域,
  + 0xF000到1M范围用于高端系统ROM BIOS的映射区
+ 1M——16M被内核用于可分配的主内存区
+ 高速缓存区和内存虚拟盘也会占用内核代码和数据后面一部分区域,该区域通常会跨越640K——1M

### BIOS

![BIOS](%E7%B4%A0%E6%9D%90/BIOS.jpg)存放在ROM中的系统BIOS程序主要用于系统各部分的自检,除了在初始化时利用BIOS提供系统参数,Linux在运行时不使用BIOS

#### 计算机启动的加载过程

+ 按下计算机的复位键后,CPU会自动把寄存器CS设为0xF000,其段基地址则设置为:0xFFFFFFF0000,段长度设置为64KB,而IP被设置为0xFFF0​,此时CPU代码指向0xFFFFFFF0处,即4G空间最后一个64K的最后16字节处.此处存放的是ROM BIOS.
+ BIOS在此处存放一条跳转指令JMP跳转到BIOS代码中64KB范围内的某一条指令开始执行
+ 现代微机中BIOS容量大多有1MB和2MB,并存储在ROM中,为了访问其他BIOS采用32位大模式,把数据段寄存器的访问范围设为4G.
+ 完成了硬件检测和初始化操作后,就会把与原来PC机兼容的64KB BIOS代码和数据复制到内存低端1M的末端64K处
+ 跳转至这个位置,CPU进入实地址模式工作
+ 最终BIOS从硬盘把操作系统引导程序加载到内存0x7c00处,跳转到这个位置执行引导程序

![计算机启动](%E7%B4%A0%E6%9D%90/%E8%AE%A1%E7%AE%97%E6%9C%BA%E5%90%AF%E5%8A%A8.jpg)

####  CMOS存储器

PC机中还使用少量的CMOS存储器来存放计算机的实时时钟信息和系统硬件配置信息,CMOS存储器需要使用I/O指令来访问.

###  控制器和控制卡

#### 中断控制器

用于实现I/O设备的中断控制数据存取方式.初始化时在内存0x000-0xFFF区域建立一个中断向量表

#### DMA控制器

#### 定时/计数器

#### 键盘控制器

#### 串行控制卡

#### 显示控制

#### 软盘和硬盘控制器



